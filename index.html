<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EnGI QMS Traceability</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
            line-height: 1.6;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        th {
            background-color: #f6f8fa;
        }
        a {
            color: #0969da;
            text-decoration: none;
        }
        a:hover {
            text-decoration: underline;
        }
        .loading {
            color: #666;
            font-style: italic;
        }
    </style>
</head>
<body>
    <h1>EnGI QMS Dynamic Traceability</h1>
    
    <div id="loading" class="loading">Loading traceability data...</div>
    
    <div id="content" style="display:none;">
        <h2>Traceability Matrix</h2>
        <table id="matrix">
            <thead>
                <tr>
                    <th>User Need</th>
                    <th>Description</th>
                    <th>Product Requirements</th>
                    <th>Category</th>
                </tr>
            </thead>
            <tbody id="matrix-body">
            </tbody>
        </table>
    </div>

    <script>
        // Simple markdown parser for our specific format
        function parseMarkdown(content) {
            const lines = content.split('\n');
            const data = {};
            let currentSection = '';
            let currentContent = [];

            for (const line of lines) {
                if (line.startsWith('## ')) {
                    if (currentSection) {
                        data[currentSection] = currentContent.join('\n').trim();
                    }
                    currentSection = line.substring(3).trim();
                    currentContent = [];
                } else if (currentSection) {
                    currentContent.push(line);
                }
            }
            if (currentSection) {
                data[currentSection] = currentContent.join('\n').trim();
            }
            return data;
        }

        // Load a markdown file from GitHub
        async function loadFile(path) {
            try {
                const response = await fetch(path);
                if (!response.ok) throw new Error(`Failed to load ${path}`);
                return await response.text();
            } catch (error) {
                console.error('Error loading file:', error);
                return null;
            }
        }

        // Build the traceability matrix
        async function buildMatrix() {
            const basePath = 'EnGI_QMS/traceability';
            
            // Load UN-001
            const unContent = await loadFile(`${basePath}/user_needs/UN-001.md`);
            if (!unContent) {
                document.getElementById('loading').textContent = 'Error loading files';
                return;
            }

            const unData = parseMarkdown(unContent);
            
            // Extract linked PRQs from the Associated Requirements section
            const prqLinks = [];
            const reqSection = unData['Associated Requirements'] || '';
            const linkRegex = /\[([^\]]+)\]\(([^\)]+)\)/g;
            let match;
            while ((match = linkRegex.exec(reqSection)) !== null) {
                prqLinks.push({
                    id: match[1],
                    path: match[2],
                    text: reqSection.substring(match.index, match.index + match[0].length)
                });
            }

            // Build table row
            const tbody = document.getElementById('matrix-body');
            const row = tbody.insertRow();
            
            // UN ID and link
            const unCell = row.insertCell();
            unCell.innerHTML = '<a href="' + basePath + '/user_needs/UN-001.md">UN-001</a>';
            
            // Description
            const descCell = row.insertCell();
            descCell.textContent = unData['User Need Description'] || '';
            
            // PRQ links
            const prqCell = row.insertCell();
            const prqLinksHtml = prqLinks.map(link => 
                `<a href="${basePath}/product_requirements/${link.id}.md">${link.id}</a>`
            ).join(', ');
            prqCell.innerHTML = prqLinksHtml || 'None';
            
            // Category
            const catCell = row.insertCell();
            catCell.textContent = unData['Category'] || '';

            // Hide loading, show content
            document.getElementById('loading').style.display = 'none';
            document.getElementById('content').style.display = 'block';
        }

        // Run when page loads
        buildMatrix();
    </script>
</body>
</html>